<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><style>* {margin: 0;padding: 0;}</style><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>WebRTC File Transfer</title></head><body><div id="login-dialog"><button onclick="rtcSetup(true)">Send</button><button onclick="rtcSetup();">Receive</button></div><br/><form id="remote-dialog"><label for="remote-input">Remote ID</label><input type="text" id="remote-input"/><input type="submit" value="Save"></form><br/><form id="ice-dialog"><input type="button" id="copy-ice" value="Copy Local Connection Info"><br/><label for="ice-input">Remote Connection Info</label><br/><input type="text" id="ice-input"/><input type="submit" value="Save"></form><br/><form id="transfer-dialog"><input type="file" id="file-selector"/><input type="submit" value="Send"></form><script>const loginDialog = document.getElementById(`login-dialog`),remoteDialog = document.getElementById(`remote-dialog`),remoteInput = document.getElementById(`remote-input`),iceDialog = document.getElementById(`ice-dialog`),iceInput = document.getElementById(`ice-input`),copyICE = document.getElementById(`copy-ice`),transferDialog = document.getElementById(`transfer-dialog`),fileSelector = document.getElementById(`file-selector`);const chunkSize = 256*1024,transferChannelCount = 512 - 1,currentTransfer = {timeStart: 0,counter: 0,filename: undefined,buffer: undefined,}, iceCandidates = [],rtc = new RTCPeerConnection({iceServers: [{urls: `stun:stun.l.google.com:19302`}]});rtc.onicecandidate = ({candidate}) => candidate && iceCandidates.push(candidate);rtc.oniceconnectionstatechange = () => {switch(rtc.iceConnectionState) {case `failed`:alert(`Connection failed. Retrying...`);rtc.restartIce();break;case `disconnected`:alert(`Disconnected`);break;case `connected`:alert(`Connection Established`);hideElements(iceDialog, copyICE);break;}};rtc.ondatachannel = ({channel}) => {if(channel.label == `metadata`) {rtc.metadataChannel = channel;rtc.metadataChannel.onmessage = ({data}) => {const signal = JSON.parse(data);if(signal.event == `start`) {currentTransfer.timeStart = new Date();currentTransfer.counter = 0;currentTransfer.buffer = new Array(signal.bufferSize);currentTransfer.filename = signal.filename;alert(`Receiving: ${signal.filename}`);}};} else {channel.onmessage = ({data}) => {let index = parseInt(channel.label),end = currentTransfer.buffer.length - 1;while(currentTransfer.buffer[index])if((index += transferChannelCount) > end)index = end;currentTransfer.buffer[index] = data;currentTransfer.counter++;if(currentTransfer.counter == end+1) {console.log(`Elapsed: ${(new Date() - currentTransfer.timeStart)/1000.0} seconds`);const link = document.createElement(`a`);hideElements(link);link.href = URL.createObjectURL(new Blob(currentTransfer.buffer));link.download = currentTransfer.filename;link.click();currentTransfer.timeStart =currentTransfer.counter = 0;currentTransfer.buffer =currentTransfer.filename = undefined;}};}console.log(`Channel initialized!`);};function hideElements(...elements) {for(const element of elements)element.style.display = `none`;}async function rtcSetup(sending) {remoteDialog.onsubmit = () => {(async () => {await rtc.setRemoteDescription(JSON.parse(atob(remoteInput.value)));if(!sending) {const answer = await rtc.createAnswer();await rtc.setLocalDescription(answer);await navigator.clipboard.writeText(btoa(JSON.stringify(answer)));alert(`Successfully saved remote ID. Local ID has been copied to your clipboard. Please send this to your peer.`);} else {alert(`Successfully saved remote ID. Please copy your local connection info and send it to your peer.`);}hideElements(remoteDialog);})();return false;};iceDialog.onsubmit = () => {(async () => {for(const ice of JSON.parse(atob(iceInput.value)))rtc.addIceCandidate(ice);alert(`Successfully saved remote connection info.`);})();return false;};copyICE.onclick = async () => {await navigator.clipboard.writeText(btoa(JSON.stringify(iceCandidates)));alert(`Local connection info has been copied to your clipboard. Please send this to your peer.`);};transferDialog.onsubmit = () => {if(fileSelector.files.length != 1 || currentTransfer.buffer) {alert(`Only 1 file is allowed to be sent at a time!`);return;}const file = fileSelector.files[0],reader = new FileReader();if(!confirm(`Confirm sending: ${file.name}`)) {alert(`Transfer cancelled`);return;}reader.onload = ({target}) => {const fileContent = target.result;rtc.metadataChannel.send(JSON.stringify({event: `start`,bufferSize: Math.ceil(1.0*fileContent.byteLength/chunkSize),filename: file.name,}));for(let chunk=0, i=0; chunk<fileContent.byteLength; i++)rtc.transferChannels[i%transferChannelCount].send(fileContent.slice(chunk, (chunk+=chunkSize)));};reader.readAsArrayBuffer(file);return false;};hideElements(loginDialog);if(sending) {const channelErrorHandler = ({error}) => console.error(error);rtc.metadataChannel = rtc.createDataChannel(`metadata`);rtc.metadataChannel.onerror = channelErrorHandler;rtc.transferChannels = new Array(transferChannelCount);for(let i=0; i<transferChannelCount; i++) {rtc.transferChannels[i] = rtc.createDataChannel(i);rtc.transferChannels[i].onerror = channelErrorHandler;}const offer = await rtc.createOffer();await rtc.setLocalDescription(offer);await navigator.clipboard.writeText(btoa(JSON.stringify(offer)));alert(`Local ID has been copied to your clipboard. Please send this to your peer`);} else {alert(`Waiting for remote ID...`);}}</script></body></html>