<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><style>* {margin: 0;padding: 0;}</style><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>WebRTC File Transfer</title></head><body><div id="login-dialog"><button onclick="rtcSetup(true)">Send</button><button onclick="rtcSetup();">Receive</button></div><br/><form id="remote-dialog"><label for="remote-input">Remote ID</label><input type="text" id="remote-input"/><input type="submit" value="Save"></form><br/><form id="ice-dialog"><input type="button" id="copy-ice" value="Copy Local Connection Info"><br/><label for="ice-input">Remote Connection Info</label><br/><input type="text" id="ice-input"/><input type="submit" value="Save"></form><br/><form id="transfer-dialog"><input type="file" id="file-selector"/><input type="submit" value="Send"></form><progress id="progress-bar" value="0"></progress><script>const loginDialog = document.getElementById(`login-dialog`),remoteDialog = document.getElementById(`remote-dialog`),remoteInput = document.getElementById(`remote-input`),iceDialog = document.getElementById(`ice-dialog`),iceInput = document.getElementById(`ice-input`),copyICE = document.getElementById(`copy-ice`),transferDialog = document.getElementById(`transfer-dialog`),fileSelector = document.getElementById(`file-selector`),progressBar = document.getElementById(`progress-bar`);const chunkSize = 256*1024,transferChannelCount = 512 - 1,currentTransfer = {timeStart: 0,filename: undefined,buffer: undefined,}, iceCandidates = [],rtc = new RTCPeerConnection({iceServers: [{urls: `stun:stun.l.google.com:19302`}]});rtc.onicecandidate = ({candidate}) => candidate && iceCandidates.push(candidate);rtc.oniceconnectionstatechange = () => {switch(rtc.iceConnectionState) {case `failed`:alert(`Connection failed. Retrying...`);rtc.restartIce();break;case `disconnected`:alert(`Disconnected`);location.reload();break;case `connected`:alert(`Connection Established`);hideElements(iceDialog, copyICE);break;}};rtc.ondatachannel = ({channel}) => {if(channel.label == `metadata`) {rtc.metadataChannel = channel;rtc.metadataChannel.onmessage = metadataHandler;} else {rtc.transferChannels[channel.label] = channel;channel.onmessage = transferHandler;}console.log(`Channel initialized!`);};function metadataHandler({data}) {const signal = JSON.parse(data);switch(signal.event) {case `request`:if(!confirm(`Confirm transfer of: '${signal.filename}'`)) {alert(`Transfer request for '${signal.filename}' denied`);rtc.metadataChannel.send(JSON.stringify({event: `denied`}));return;}alert(`Transfer request for '${signal.filename}' was accepted.`);currentTransfer.timeStart = new Date();currentTransfer.fileContent = new Array(progressBar.max = signal.bufferSize);currentTransfer.filename = signal.filename;rtc.metadataChannel.send(JSON.stringify({event: `accepted`}));break;case `accepted`:alert(`Transfer request for '${currentTransfer.filename}' was accepted.`);for(let chunk=0, i=0; chunk<currentTransfer.fileContent.byteLength; i++)rtc.transferChannels[i%transferChannelCount].send(currentTransfer.fileContent.slice(chunk, (chunk+=chunkSize)));break;case `denied`:alert(`Transfer request for '${currentTransfer.filename}' was denied.`);resetTransfer();break;case `progress`:progressBar.value = signal.value;if(!signal.value) {alert(`Transfer complete. '${currentTransfer.filename}' was sent in ${signal.timeElapsed} seconds`);resetTransfer();}break;}}function transferHandler({target, data}) {let index = parseInt(target.label),end = currentTransfer.fileContent.length - 1;while(currentTransfer.fileContent[index])if((index += transferChannelCount) > end)index = end;currentTransfer.fileContent[index] = data;rtc.metadataChannel.send(JSON.stringify({event: `progress`,value: ++progressBar.value}));if(progressBar.value == progressBar.max) {const duration = (new Date() - currentTransfer.timeStart)/1000.0;console.log(`Elapsed: ${duration} seconds`);const link = document.createElement(`a`);hideElements(link);link.href = URL.createObjectURL(new Blob(currentTransfer.fileContent));link.download = currentTransfer.filename;link.click();rtc.metadataChannel.send(JSON.stringify({event: `progress`, value: 0, timeElapsed: duration}));resetTransfer();}}function resetTransfer() {progressBar.value =currentTransfer.timeStart =currentTransfer.fileContent =currentTransfer.filename = 0;}async function rtcSetup(sending) {remoteDialog.onsubmit = () => {(async () => {await rtc.setRemoteDescription(JSON.parse(atob(remoteInput.value)));if(!sending) {const answer = await rtc.createAnswer();await rtc.setLocalDescription(answer);await navigator.clipboard.writeText(btoa(JSON.stringify(answer)));alert(`Successfully saved remote ID. Local ID has been copied to your clipboard. Please send this to your peer.`);} else {alert(`Successfully saved remote ID. Please copy your local connection info and send it to your peer.`);}hideElements(remoteDialog);})();return false;};iceDialog.onsubmit = () => {(async () => {for(const ice of JSON.parse(atob(iceInput.value)))rtc.addIceCandidate(ice);alert(`Successfully saved remote connection info.`);})();return false;};copyICE.onclick = async () => {await navigator.clipboard.writeText(btoa(JSON.stringify(iceCandidates)));alert(`Local connection info has been copied to your clipboard. Please send this to your peer.`);};transferDialog.onsubmit = () => {if(!fileSelector.files) {alert(`No files selected. Please select a file before sending.`);return;} else if(fileSelector.files.length != 1 || currentTransfer.fileContent) {alert(`Only 1 file is allowed to be sent at a time.`);return;}const file = fileSelector.files[0],reader = new FileReader();if(!confirm(`Confirm transfer of: '${file.name}'`)) {alert(`Transfer cancelled`);return;}reader.onload = ({target}) => {const fileContent = target.result;rtc.metadataChannel.send(JSON.stringify({event: `request`,bufferSize: Math.ceil(1.0*fileContent.byteLength/chunkSize),filename: file.name,}));progressBar.value = 0;progressBar.max = Math.ceil(1.0*fileContent.byteLength/chunkSize);currentTransfer.fileContent = fileContent;currentTransfer.filename = file.name;};reader.readAsArrayBuffer(file);return false;};hideElements(loginDialog);rtc.transferChannels = new Array(transferChannelCount);if(sending) {const channelErrorHandler = ({error}) => console.error(error);rtc.metadataChannel = rtc.createDataChannel(`metadata`);rtc.metadataChannel.onerror = channelErrorHandler;rtc.metadataChannel.onmessage = metadataHandler;for(let i=0; i<transferChannelCount; i++) {const channel = rtc.transferChannels[i] = rtc.createDataChannel(i);channel.onmessage = transferHandler;channel.onerror = channelErrorHandler;}const offer = await rtc.createOffer();await rtc.setLocalDescription(offer);await navigator.clipboard.writeText(btoa(JSON.stringify(offer)));alert(`Local ID has been copied to your clipboard. Please send this to your peer`);} else {alert(`Waiting for remote ID...`);}}function hideElements(...elements) {for(const element of elements)element.style.display = `none`;}</script></body></html>